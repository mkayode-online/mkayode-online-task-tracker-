<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mkayode Online Task Tracker</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        body { margin: 0; padding: 0; }
    </style>
</head>
<body>
<div id="root"></div>

<script>
/* ======================================================
   FIREBASE CONFIG
====================================================== */
const firebaseConfig = {
    apiKey: "AIzaSyD2Lj6-ML72Ok3ZhMlN2_GorYOguZzyRQY",
    authDomain: "mkayo-tasks-tracker.firebaseapp.com",
    databaseURL: "https://mkayo-tasks-tracker-default-rtdb.firebaseio.com",
    projectId: "mkayo-tasks-tracker",
    storageBucket: "mkayo-tasks-tracker.firebasestorage.app",
    messagingSenderId: "247715284898",
    appId: "1:247715284898:web:57b66ddd7483061b9694fb"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

const ADMIN_EMAIL = "mkayodeonline@gmail.com";

/* ======================================================
   APP STATE
====================================================== */
let currentUser = null;
let isAdmin = false;
let currentView = 'login';

/* ======================================================
   ICONS
====================================================== */
const Icons = {
    Plus: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
    Trash: `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path></svg>`,
    Moon: `<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>`,
    Sun: `<svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/></svg>`,
    LogOut: `<svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><line x1="21" y1="12" x2="9" y2="12"/></svg>`
};

/* ======================================================
   MESSAGES
====================================================== */
function showMessage(msg, type='info'){
    const c = {error:'bg-red-500', success:'bg-green-500', info:'bg-blue-500'};
    const d=document.createElement('div');
    d.className=`fixed top-4 right-4 ${c[type]} text-white px-6 py-3 rounded-lg z-50`;
    d.textContent=msg;
    document.body.appendChild(d);
    setTimeout(()=>d.remove(),3000);
}

/* ======================================================
   AUTH
====================================================== */
auth.onAuthStateChanged(user=>{
    if(user){
        currentUser=user;
        isAdmin=user.email===ADMIN_EMAIL;
        currentView='tasks';
    }else{
        currentUser=null;
        isAdmin=false;
        currentView='login';
    }
    render();
});

/* ======================================================
   RENDER CORE
====================================================== */
function render(){
    const root=document.getElementById('root');
    if(currentView==='login') root.innerHTML=renderLogin();
    if(currentView==='tasks') {
        root.innerHTML=renderTasksPage();
        initializeTasksPage();
    }
}

/* ======================================================
   LOGIN
====================================================== */
function renderLogin(){
return `
<div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-50 to-purple-50">
<div class="bg-white p-8 rounded-xl shadow w-full max-w-md">
<h2 class="text-2xl font-bold mb-4">Login</h2>
<input id="login-email" class="border p-3 w-full mb-3 rounded" placeholder="Email">
<input id="login-password" type="password" class="border p-3 w-full mb-4 rounded" placeholder="Password">
<button onclick="handleLogin()" class="bg-indigo-600 text-white w-full py-3 rounded">Login</button>
</div>
</div>`;
}

function handleLogin(){
    auth.signInWithEmailAndPassword(
        document.getElementById('login-email').value,
        document.getElementById('login-password').value
    ).catch(e=>showMessage(e.message,'error'));
}

/* ======================================================
   TASKS PAGE (UPDATED)
====================================================== */
function renderTasksPage(){
const dark = localStorage.getItem('darkMode')==='true';
return `
<div class="${dark?'bg-gray-900':'bg-gray-100'} min-h-screen p-6">
<div class="max-w-7xl mx-auto space-y-6">

<div class="flex justify-between items-center">
<h1 class="${dark?'text-white':'text-gray-800'} text-3xl font-bold">Task Dashboard</h1>
<div class="flex gap-2">
<button onclick="toggleDarkMode()" class="p-3 bg-white rounded">${dark?Icons.Sun:Icons.Moon}</button>
<button onclick="auth.signOut()" class="px-4 py-2 bg-red-600 text-white rounded">Logout</button>
</div>
</div>

<div class="flex gap-3">
<select id="monthSelect" onchange="saveMonthYear()" class="p-2 rounded border">
${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].map((m,i)=>`<option value="${i+1}">${m}</option>`).join('')}
</select>
<select id="yearSelect" onchange="saveMonthYear()" class="p-2 rounded border">
<option>2025</option><option>2026</option><option>2027</option>
</select>
</div>

<div id="dashboard" class="grid md:grid-cols-3 gap-6"></div>

<button onclick="addNewTask()" class="flex items-center gap-2 bg-indigo-600 text-white px-5 py-3 rounded">
${Icons.Plus} Add Task
</button>

<div id="tasks-list" class="space-y-3"></div>

</div>
</div>`;
}

/* ======================================================
   DASHBOARD LOGIC
====================================================== */
function initializeTasksPage(){
if(!currentUser) return;
database.ref('tasks/'+currentUser.uid).on('value',snap=>{
    const tasks=Object.entries(snap.val()||{}).map(([id,t])=>({id,...t}));
    renderDashboard(tasks);
    renderTasks(tasks);
});
}

function renderDashboard(tasks){
const m=Number(localStorage.getItem('selectedMonth')||1);
const y=Number(localStorage.getItem('selectedYear')||2026);
document.getElementById('monthSelect').value=m;
document.getElementById('yearSelect').value=y;

const filtered=tasks.filter(t=>t.month===m&&t.year===y);
const done=filtered.filter(t=>t.completed).length;
const pct=filtered.length?Math.round(done/filtered.length*100):0;

document.getElementById('dashboard').innerHTML=`
<div class="bg-indigo-600 text-white p-6 rounded-xl">
<h3>Month Overview</h3>
<p class="text-4xl font-bold">${pct}%</p>
<p>${done}/${filtered.length} completed</p>
</div>
<div class="bg-white p-6 rounded-xl">
<h3 class="font-semibold mb-3">Weekly Progress</h3>
${[1,2,3,4].map(w=>{
const wt=filtered.filter(t=>t.week===w);
const wp=wt.length?Math.round(wt.filter(t=>t.completed).length/wt.length*100):0;
return `<div class="mb-2">Week ${w}<div class="h-2 bg-gray-200 rounded"><div class="h-2 bg-indigo-600 rounded" style="width:${wp}%"></div></div></div>`;
}).join('')}
</div>
<div class="bg-white p-6 rounded-xl">
<h3 class="font-semibold mb-3">Categories</h3>
${[...new Set(filtered.map(t=>t.category))].map(c=>{
const ct=filtered.filter(t=>t.category===c);
const cp=Math.round(ct.filter(t=>t.completed).length/ct.length*100||0);
return `<div class="mb-2">${c}<div class="h-2 bg-gray-200 rounded"><div class="h-2 bg-indigo-600 rounded" style="width:${cp}%"></div></div></div>`;
}).join('')}
</div>`;
}

/* ======================================================
   TASK LIST
====================================================== */
function renderTasks(tasks){
const list=document.getElementById('tasks-list');
const m=Number(localStorage.getItem('selectedMonth')||1);
const y=Number(localStorage.getItem('selectedYear')||2026);
const filtered=tasks.filter(t=>t.month===m&&t.year===y);

list.innerHTML=filtered.map(t=>`
<div class="bg-white p-4 rounded shadow flex justify-between items-center">
<div>
<p class="${t.completed?'line-through text-gray-400':''} font-medium">${t.title}</p>
<p class="text-sm text-gray-500">Week ${t.week} â€¢ ${t.category}</p>
</div>
<div class="flex gap-2">
<input type="checkbox" ${t.completed?'checked':''} onchange="toggleTask('${t.id}',${!t.completed})">
<button onclick="deleteTask('${t.id}')" class="text-red-600">${Icons.Trash}</button>
</div>
</div>`).join('');
}

/* ======================================================
   TASK ACTIONS
====================================================== */
function saveMonthYear(){
localStorage.setItem('selectedMonth',monthSelect.value);
localStorage.setItem('selectedYear',yearSelect.value);
initializeTasksPage();
}

function addNewTask(){
const title=prompt('Task title');
if(!title) return;
database.ref('tasks/'+currentUser.uid).push({
title, week:1, category:'Work',
month:Number(localStorage.getItem('selectedMonth')||1),
year:Number(localStorage.getItem('selectedYear')||2026),
completed:false
});
}

function toggleTask(id,val){
database.ref(`tasks/${currentUser.uid}/${id}/completed`).set(val);
}

function deleteTask(id){
if(confirm('Delete task?')){
database.ref(`tasks/${currentUser.uid}/${id}`).remove();
}
}

function toggleDarkMode(){
localStorage.setItem('darkMode',!(localStorage.getItem('darkMode')==='true'));
render();
}

/* INIT */
render();
</script>
</body>
</html>
