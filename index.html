<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MKayode CRM Tracker</title>

<script src="https://cdn.tailwindcss.com"></script>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>

<body class="bg-gray-100">
<div id="root"></div>

<script>
/* ================= CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyD2Lj6-ML72Ok3ZhMlN2_GorYOguZzyRQY",
  authDomain: "mkayo-tasks-tracker.firebaseapp.com",
  databaseURL: "https://mkayo-tasks-tracker-default-rtdb.firebaseio.com",
  projectId: "mkayo-tasks-tracker",
  storageBucket: "mkayo-tasks-tracker.appspot.com",
  messagingSenderId: "247715284898",
  appId: "1:247715284898:web:57b66ddd7483061b9694fb"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const ADMIN_EMAIL = "mkayodeonline@gmail.com";

/* ================= STATE ================= */
let currentUser = null;
let isAdmin = false;
let view = "login";

/* ================= HELPERS ================= */
function render() {
  const root = document.getElementById("root");
  if(view==="login") root.innerHTML = loginView();
  if(view==="register") root.innerHTML = registerView();
  if(view==="user") root.innerHTML = userDashboard();
  if(view==="admin") root.innerHTML = adminDashboard();
  if(view==="adminTasks") root.innerHTML = adminTasksDashboard();
}

function logout() {
  auth.signOut();
}

/* ================= AUTH ================= */
auth.onAuthStateChanged(user=>{
  currentUser = user;
  isAdmin = user && user.email === ADMIN_EMAIL;
  view = user ? (isAdmin ? "admin" : "user") : "login";
  render();
});

/* ================= VIEWS ================= */
function loginView() {
return `
<div class="min-h-screen flex items-center justify-center">
<div class="bg-white p-8 rounded-xl shadow w-full max-w-md">
<h2 class="text-2xl font-bold mb-4 text-center">Login</h2>
<input id="email" class="w-full border p-3 mb-3 rounded" placeholder="Email">
<input id="password" type="password" class="w-full border p-3 mb-4 rounded" placeholder="Password">
<button onclick="auth.signInWithEmailAndPassword(email.value,password.value)" class="w-full bg-indigo-600 text-white p-3 rounded">Login</button>
<p class="text-center mt-4">
<button onclick="view='register';render()" class="text-indigo-600">Create account</button>
</p>
</div>
</div>`;
}

function registerView() {
return `
<div class="min-h-screen flex items-center justify-center">
<div class="bg-white p-8 rounded-xl shadow w-full max-w-md">
<h2 class="text-2xl font-bold mb-4 text-center">Register</h2>
<input id="name" class="w-full border p-3 mb-3 rounded" placeholder="Full name">
<input id="email" class="w-full border p-3 mb-3 rounded" placeholder="Email">
<input id="password" type="password" class="w-full border p-3 mb-4 rounded" placeholder="Password">
<button onclick="register()" class="w-full bg-indigo-600 text-white p-3 rounded">Register</button>
</div>
</div>`;
}

function userDashboard() {
return `
<div class="p-6 max-w-4xl mx-auto">
<div class="flex justify-between items-center mb-6">
<h1 class="text-3xl font-bold">User Dashboard</h1>
<button onclick="openTaskModal()"
class="bg-indigo-600 text-white px-4 py-2 rounded mb-4">
+ Add New Task
</button>

<!-- TASK MODAL -->
<div id="taskModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl w-full max-w-md p-6">
    <h2 class="text-xl font-bold mb-4">Add New Task</h2>

    <input id="taskTitle" class="w-full border p-3 rounded mb-3"
      placeholder="Task title">

    <textarea id="taskDesc" class="w-full border p-3 rounded mb-3"
      placeholder="Task description"></textarea>

    <div class="flex gap-2 mb-3">
      <select id="taskWeek" class="w-full border p-2 rounded">
        <option value="1">Week 1</option>
        <option value="2">Week 2</option>
        <option value="3">Week 3</option>
        <option value="4">Week 4</option>
      </select>

      <select id="taskCategory" class="w-full border p-2 rounded">
        <option>Work</option>
        <option>Personal</option>
        <option>Health</option>
        <option>Learning</option>
        <option>Finance</option>
      </select>
    </div>

    <input id="taskDue" type="date"
      class="w-full border p-2 rounded mb-4">

    <div class="flex justify-end gap-2">
      <button onclick="closeTaskModal()"
        class="px-4 py-2 bg-gray-300 rounded">
        Cancel
      </button>
      <button onclick="saveTask()"
        class="px-4 py-2 bg-indigo-600 text-white rounded">
        Save Task
      </button>
    </div>
  </div>
</div>

function openTaskModal(){
  document.getElementById("taskModal").classList.remove("hidden");
  document.getElementById("taskModal").classList.add("flex");
}

function closeTaskModal(){
  document.getElementById("taskModal").classList.add("hidden");
}

function saveTask(){
  const title = taskTitle.value.trim();
  if(!title) return alert("Task title required");

  const month = new Date().getMonth()+1;
  const year = new Date().getFullYear();

  db.ref("tasks/"+currentUser.uid).push({
    title,
    description: taskDesc.value,
    week: Number(taskWeek.value),
    category: taskCategory.value,
    dueDate: taskDue.value,
    month,
    year,
    completed:false,
    createdAt: Date.now()
  });

  closeTaskModal();
}

}

function adminDashboard() {
return `
<div class="p-6 max-w-6xl mx-auto">
<div class="flex justify-between items-center mb-6">
<h1 class="text-3xl font-bold">Admin Dashboard</h1>
<button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded">Logout</button>
</div>

<div class="grid grid-cols-3 gap-4 mb-6">
<div class="bg-white p-4 rounded shadow">Users: <span id="userCount">0</span></div>
<div class="bg-white p-4 rounded shadow">Tasks: <span id="taskCount">0</span></div>
<div class="bg-white p-4 rounded shadow">Completed: <span id="doneCount">0</span></div>
</div>

<button onclick="view='adminTasks';render()" class="bg-indigo-600 text-white px-4 py-2 rounded">
View All Tasks
</button>
</div>`;
}

function adminTasksDashboard() {
return `
<div class="p-6 max-w-6xl mx-auto">
<div class="flex justify-between items-center mb-6">
<h1 class="text-3xl font-bold">Admin Task Board</h1>
<button onclick="view='admin';render()" class="bg-gray-600 text-white px-4 py-2 rounded">Back</button>
</div>
<div id="allTasks"></div>
</div>`;
}

/* ================= LOGIC ================= */
function register() {
  auth.createUserWithEmailAndPassword(email.value,password.value)
  .then(res=>{
    db.ref("users/"+res.user.uid).set({name:name.value,email:email.value});
  });
}

function addTask() {
  const title = prompt("Task title");
  if(!title) return;
  db.ref("tasks/"+currentUser.uid).push({
    title,completed:false,createdAt:Date.now()
  });
}

db.ref("tasks").on("value",snap=>{
  if(!snap.exists()) return;
  const tasks = snap.val();
  let total = 0, done = 0;

  Object.values(tasks).forEach(u=>{
    Object.values(u).forEach(t=>{
      total++;
      if(t.completed) done++;
    });
  });

  document.getElementById("taskCount")?.innerText = total;
  document.getElementById("doneCount")?.innerText = done;
});

db.ref("users").on("value",snap=>{
  document.getElementById("userCount")?.innerText = snap.numChildren();
});

db.ref("tasks/"+(currentUser?.uid||"")).on("value",snap=>{
  if(!snap.exists()) return;
  const box = document.getElementById("userTasks");
  if(!box) return;
  box.innerHTML = Object.entries(snap.val()).map(([id,t])=>`
    <div class="bg-white p-3 rounded shadow mb-2 flex justify-between">
      <span>${t.title}</span>
      <input type="checkbox" ${t.completed?"checked":""}
      onchange="db.ref('tasks/${currentUser.uid}/${id}/completed').set(this.checked)">
    </div>
  `).join("");
});

db.ref("tasks").on("value",snap=>{
  const box = document.getElementById("allTasks");
  if(!box || !snap.exists()) return;

  const data = snap.val();
  box.innerHTML = Object.entries(data).map(([uid,tasks])=>`
    <div class="mb-4">
      <h3 class="font-bold mb-2">User: ${uid}</h3>
      ${Object.values(tasks).map(t=>`
        <div class="bg-white p-2 rounded shadow mb-1">${t.title}</div>
      `).join("")}
    </div>
  `).join("");
});

render();
</script>
</body>
</html>
